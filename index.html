<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Compressor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <h1 class="text-3xl font-bold mb-6">Compress your PDF</h1>

  <div class="bg-white rounded-xl shadow p-6 w-full max-w-md text-center">
    <input id="fileInput" type="file" accept="application/pdf" class="mb-4" />
    <button onclick="uploadPDF()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
      Compress PDF
    </button>

    <div id="status" class="mt-4 text-sm text-gray-700"></div>

    <div id="bar" class="w-full h-2 bg-gray-300 rounded mt-2 hidden">
      <div id="fill" class="h-full bg-blue-600 rounded" style="width:0%"></div>
    </div>
  </div>

  <script>
    // Адрес API: можно переопределить через <script>window.API_URL='…'</script> ДО этого файла
    const API = window.API_URL || 'https://pdf-compress.fly.dev';

    async function uploadPDF() {
      const fileInput = document.getElementById('fileInput');
      const status    = document.getElementById('status');
      const bar       = document.getElementById('bar');
      const fill      = document.getElementById('fill');

      if (!fileInput.files.length) {
        status.textContent = 'Choose a PDF first';
        return;
      }

      const file = fileInput.files[0];

      // UI reset
      status.textContent = 'Uploading…';
      bar.classList.remove('hidden');
      fill.style.width = '0%';

      const fd = new FormData();
      fd.append('file', file);

      let taskId;
      try {
        const resp = await fetch(`${API}/compress`, { method: 'POST', body: fd });
        if (!resp.ok) throw new Error(`Upload failed (${resp.status})`);
        ({ taskId } = await resp.json());
      } catch (err) {
        console.error(err);
        status.textContent = '❌ ' + err.message;
        return;
      }

      // Поллинг прогресса каждые 2 сек
      const poller = setInterval(async () => {
        try {
          const progResp = await fetch(`${API}/status/${taskId}`);
          if (!progResp.ok) throw new Error('Status error');

          const { progress, error } = await progResp.json();
          if (error) throw new Error('Compression failed');

          status.textContent = `Compressing: ${progress}%`;
          fill.style.width   = progress + '%';

          if (progress >= 99) {
            clearInterval(poller);
            status.textContent = 'Downloading…';

            const blob = await fetch(`${API}/download/${taskId}`).then(r => r.blob());
            const url  = URL.createObjectURL(blob);

            // Автозагрузка файла
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name.replace(/\.pdf$/i, '-compressed.pdf');
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            a.remove();

            status.innerHTML = '✅ Done!';
            fill.style.width = '100%';
          }
        } catch (err) {
          clearInterval(poller);
          console.error(err);
          status.textContent = '❌ ' + err.message;
        }
      }, 2000);
    }
  </script>
</body>
</html>
